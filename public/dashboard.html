<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - Sistema de Orqu√≠deas</title>

    <!-- Materialize CSS CDN -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">

    <!-- Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            display: flex;
            min-height: 100vh;
            flex-direction: column;
        }

        main {
            flex: 1 0 auto;
            padding: 16px;
        }

        .sensor-badge {
            font-weight: 600;
        }

        .card-stats {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .small-muted {
            font-size: 0.85rem;
            color: #666;
        }

        @media (min-width: 993px) {
            .grid-2 {
                display: grid;
                grid-template-columns: 1fr 420px;
                gap: 16px;
            }
        }
    </style>
</head>

<body>

    <!-- NAV -->
    <nav class="green darken-2">
        <div class="nav-wrapper container">
            <a href="inicio.html" class="brand-logo">Orqu√≠deas 4.0</a>
            <ul id="nav-mobile" class="right hide-on-med-and-down">
                <li><a href="#dashboard">Dashboard</a></li>
                <li><a href="calendario.html">Calendario</a></li>
                <li><a href="inicio.html">Inicio</a></li>
            </ul>
        </div>
    </nav>

    <main class="container">
        <!-- Dashboard Limpio y Ordenado -->
        <section id="dashboard">
            <h4>Sistema de Monitoreo de Orqu√≠deas</h4>
            <p class="grey-text">Datos en tiempo real de sensores IoT especializados en plantas</p>
            
            <div class="row">
                <!-- Panel Principal de Datos -->
                <div class="col s12 l8">
                    <div class="card">
                        <div class="card-content">
                            <h5>üìä Condiciones Actuales</h5>
                            
                            <div class="row">
                                <div class="col s6">
                                    <div class="center-align">
                                        <h2 id="tempValue" class="blue-text text-darken-2">--¬∞C</h2>
                                        <h6>Temperatura</h6>
                                        <p class="small-muted">Rango ideal: 18¬∞C - 24¬∞C</p>
                                    </div>
                                </div>
                                <div class="col s6">
                                    <div class="center-align">
                                        <h2 id="humValue" class="teal-text text-darken-2">--%</h2>
                                        <h6>Humedad</h6>
                                        <p class="small-muted">Ideal: 60% - 80%</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="divider"></div>
                            
                            <!-- Selector de Ubicaciones -->
                            <div style="margin-top:20px;">
                                <h6>ÔøΩ Seleccionar Ubicaci√≥n Clim√°tica</h6>
                                <p class="small-muted">Escolha diferentes ubicaciones para obtener datos clim√°ticos reales</p>
                                
                                <div class="row">
                                    <div class="col s12">
                                        <div class="input-field">
                                            <select id="locationSelector">
                                                <optgroup label="üá®üá¥ Colombia - Ideal para Orqu√≠deas">
                                                    <option value="openweather-bogota">üèîÔ∏è Bogot√° D.C. (Tropical de Altura)</option>
                                                    <option value="weatherapi-medellin">üå∏ Medell√≠n (Tropical Montano - Excelente)</option>
                                                    <option value="wttr-cali">‚òÄÔ∏è Cali (Tropical Seco)</option>
                                                </optgroup>
                                                <optgroup label="üá®üá± Chile - Clima Templado">
                                                    <option value="chile-openweather">üèôÔ∏è Santiago (Mediterr√°neo)</option>
                                                    <option value="chile-wttr">üåä Valpara√≠so (Mediterr√°neo Costero)</option>
                                                    <option value="chile-concepcion">üåßÔ∏è Concepci√≥n (Oce√°nico)</option>
                                                    <option value="puerto-montt">‚ùÑÔ∏è Puerto Montt (Oce√°nico Templado)</option>
                                                </optgroup>
                                                <optgroup label="ü•∂ Patagonia - Climas Extremos">
                                                    <option value="punta-arenas">üå¨Ô∏è Punta Arenas (Subpolar - Muy Fr√≠o)</option>
                                                    <option value="ushuaia">üßä Ushuaia (Subant√°rtico - Extremo)</option>
                                                </optgroup>
                                            </select>
                                            <label>Seleccionar ubicaci√≥n clim√°tica</label>
                                        </div>
                                        <div class="center-align">
                                            <a class="btn purple darken-2 waves-effect" id="btnChangeLocation">
                                                <i class="material-icons left">location_on</i>
                                                Cambiar Ubicaci√≥n
                                            </a>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Info de la ubicaci√≥n actual -->
                                <div class="card-panel purple lighten-5" style="margin-top:12px;">
                                    <div class="center-align">
                                        <strong>üìç Ubicaci√≥n Actual</strong><br>
                                        <span id="currentLocationName" class="flow-text purple-text">Santiago de Chile</span><br>
                                        <small class="grey-text">
                                            üå°Ô∏è <span id="currentClimate">Clima mediterr√°neo</span> | 
                                            üå∫ <span id="currentOrchidSuitability">Adecuaci√≥n para orqu√≠deas: Media</span>
                                        </small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="divider"></div>
                            
                            <!-- Controles IoT -->
                            <div style="margin-top:20px;">
                                <h6>üå± Obtener Datos Clim√°ticos</h6>
                                <p class="small-muted">Conectado a estaciones meteorol√≥gicas reales</p>
                                
                                <div class="row">
                                    <div class="col s12 m4">
                                        <a class="btn blue darken-1 waves-effect btn-block" id="btnRealTemp">
                                            <i class="material-icons left">device_thermostat</i>
                                            Obtener Temperatura
                                        </a>
                                    </div>
                                    <div class="col s12 m4">
                                        <a class="btn teal darken-1 waves-effect btn-block" id="btnRealHumidity">
                                            <i class="material-icons left">opacity</i>
                                            Obtener Humedad
                                        </a>
                                    </div>
                                    <div class="col s12 m4">
                                        <a class="btn orange darken-1 waves-effect btn-block" id="btnAutoReal">
                                            <i class="material-icons left">refresh</i>
                                            Auto-actualizaci√≥n
                                        </a>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Panel de Estado -->
                            <div id="realDataPanel" class="card-panel green lighten-5" style="margin-top:16px;">
                                <div id="realDataStatus" class="center-align">
                                    üåê Presiona un bot√≥n para conectar con sensores IoT reales
                                </div>
                                <div id="realDataInfo" style="display:none; margin-top:12px;">
                                    <div class="row">
                                        <div class="col s6 center-align">
                                            <strong>üå°Ô∏è Temperatura Real</strong><br>
                                            <span id="iotTemp" class="flow-text blue-text">--¬∞C</span>
                                        </div>
                                        <div class="col s6 center-align">
                                            <strong>üíß Humedad Real</strong><br>
                                            <span id="iotHumidity" class="flow-text teal-text">--%</span>
                                        </div>
                                    </div>
                                    <div class="center-align" style="margin-top:8px;">
                                        <small class="grey-text">
                                            üì° <span id="iotSource">--</span> | 
                                            ‚è∞ <span id="iotTimestamp">--</span> | 
                                            üîÑ <span id="lastUpdated">--</span>
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Panel Lateral de Informaci√≥n -->
                <div class="col s12 l4">
                    <div class="card">
                        <div class="card-content">
                            <h6>üìà Gr√°fico Hist√≥rico</h6>
                            <canvas id="historyChart" height="200"></canvas>
                        </div>
                    </div>
                    
                    <div class="card blue lighten-5">
                        <div class="card-content">
                            <h6>üìç Fuente Actual de Datos</h6>
                            <ul class="collection">
                                <li class="collection-item">
                                    <strong>Estaci√≥n:</strong><br>
                                    <span id="sourceStation">--</span>
                                </li>
                                <li class="collection-item">
                                    <strong>Ubicaci√≥n:</strong><br>
                                    <span id="sourceLocation">--</span>
                                </li>
                                <li class="collection-item">
                                    <strong>Coordenadas:</strong><br>
                                    <span id="sourceCoordinates">--</span>
                                </li>
                                <li class="collection-item">
                                    <strong>Proveedor:</strong><br>
                                    <span id="sourceProvider">--</span>
                                </li>
                                <li class="collection-item">
                                    <strong>Tipo de Clima:</strong><br>
                                    <span id="sourceClimate">--</span>
                                </li>
                                <li class="collection-item">
                                    <strong>üå∫ Adecuaci√≥n para Orqu√≠deas:</strong><br>
                                    <span id="sourceOrchidSuitability" class="badge">--</span>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <div class="card orange lighten-5">
                        <div class="card-content">
                            <h6>üìä Historial de Consultas</h6>
                            <div style="max-height: 300px; overflow-y: auto;">
                                <table class="striped responsive-table" style="font-size: 0.9em;">
                                    <thead>
                                        <tr>
                                            <th>Hora</th>
                                            <th>Fuente</th>
                                            <th>Temp</th>
                                            <th>Hum</th>
                                        </tr>
                                    </thead>
                                    <tbody id="queryHistoryTable">
                                        <tr>
                                            <td colspan="4" class="center-align grey-text">
                                                No hay consultas realizadas
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="center-align" style="margin-top: 10px;">
                                <span class="grey-text">Total consultas: <span id="totalQueries">0</span></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- Materialize & dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

    <script>
        // ====== Inicializaci√≥n Materialize ======
        document.addEventListener('DOMContentLoaded', function () {
            M.AutoInit(); // Inicializaci√≥n autom√°tica de todos los componentes
        });

        // ====== Estado del sistema ======
        let history = loadHistory() || []; // array of {ts, temp, hum}

        // Chart setup limpio
        const ctx = document.getElementById('historyChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: history.map(h => new Date(h.ts).toLocaleString()),
                datasets: [
                    { 
                        label: 'Humedad (%)', 
                        data: history.map(h => h.hum), 
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        yAxisID: 'y1', 
                        tension: 0.3 
                    },
                    { 
                        label: 'Temperatura (¬∞C)', 
                        data: history.map(h => h.temp), 
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        yAxisID: 'y2', 
                        tension: 0.3 
                    }
                ]
            },
            options: {
                responsive: true,
                interaction: { mode: 'index', intersect: false },
                scales: {
                    y1: { 
                        type: 'linear', 
                        position: 'left', 
                        suggestedMin: 0, 
                        suggestedMax: 100,
                        title: { display: true, text: 'Humedad (%)' }
                    },
                    y2: { 
                        type: 'linear', 
                        position: 'right', 
                        suggestedMin: 0, 
                        suggestedMax: 40,
                        title: { display: true, text: 'Temperatura (¬∞C)' }
                    }
                },
                plugins: {
                    legend: { display: true, position: 'top' }
                }
            }
        });

        function refreshChart() {
            chart.data.labels = history.slice(-20).map(h => new Date(h.ts).toLocaleTimeString());
            chart.data.datasets[0].data = history.slice(-20).map(h => h.hum);
            chart.data.datasets[1].data = history.slice(-20).map(h => h.temp);
            chart.update();
        }

        // ====== APIS SIN CORS - DATOS REALES ======
        
        // APIs p√∫blicas - SOLO CHILE ACTIVAS
        const DATA_SOURCES = [
            // ===== FUENTES COLOMBIA (ACTIVADAS) =====
            {
                id: 'openweather-bogota',
                name: 'OpenWeather Colombia',
                description: 'Estaci√≥n Meteorol√≥gica El Dorado',
                city: 'Bogot√° D.C.',
                location: 'Aeropuerto El Dorado',
                coordinates: '4.7110¬∞N, 74.0721¬∞W',
                provider: 'OpenWeatherMap API',
                climate: 'tropical-altitude',
                orchidSuitability: 'alta',
                url: 'https://api.openweathermap.org/data/2.5/weather?q=Bogota,CO&appid=demo&units=metric',
                parser: (data) => ({
                    temp: data.main?.temp || 22,
                    hum: data.main?.humidity || 70,
                    pressure: data.main?.pressure || 1013,
                    condition: data.weather?.[0]?.description || 'Parcialmente nublado'
                })
            },
            {
                id: 'weatherapi-medellin',
                name: 'WeatherAPI Medell√≠n', 
                description: 'Estaci√≥n Jos√© Mar√≠a C√≥rdova',
                city: 'Medell√≠n, Antioquia',
                location: 'Aeropuerto Jos√© Mar√≠a C√≥rdova',
                coordinates: '6.2442¬∞N, 75.5812¬∞W',
                provider: 'WeatherAPI.com',
                climate: 'tropical-montano',
                orchidSuitability: 'muy-alta',
                url: 'http://api.weatherapi.com/v1/current.json?key=demo&q=Medellin&aqi=no',
                parser: (data) => ({
                    temp: data.current?.temp_c || 24,
                    hum: data.current?.humidity || 75,
                    pressure: data.current?.pressure_mb || 1015,
                    condition: data.current?.condition?.text || 'Soleado'
                })
            },
            {
                id: 'wttr-cali',
                name: 'WTTR.in Cali',
                description: 'Estaci√≥n Alfonso Bonilla Arag√≥n',
                city: 'Cali, Valle del Cauca',
                location: 'Aeropuerto Alfonso Bonilla Arag√≥n',
                coordinates: '3.5430¬∞N, 76.3816¬∞W',
                provider: 'WTTR Weather Service',
                climate: 'tropical-seco',
                orchidSuitability: 'media-alta',
                url: 'https://wttr.in/Cali?format=j1',
                parser: (data) => ({
                    temp: parseFloat(data.current_condition?.[0]?.temp_C) || 26,
                    hum: parseFloat(data.current_condition?.[0]?.humidity) || 80,
                    pressure: parseFloat(data.current_condition?.[0]?.pressure) || 1012,
                    condition: data.current_condition?.[0]?.weatherDesc?.[0]?.value || 'Parcialmente nublado'
                })
            },
            
            // ===== FUENTES CHILE (ACTIVAS) =====
            {
                id: 'chile-openweather',
                name: 'OpenWeather Chile',
                description: 'Estaci√≥n Meteorol√≥gica Pudahuel',
                city: 'Santiago de Chile',
                location: 'Aeropuerto Arturo Merino Ben√≠tez',
                coordinates: '33.3928¬∞S, 70.7856¬∞W',
                provider: 'OpenWeatherMap Chile',
                climate: 'mediterraneo',
                orchidSuitability: 'media',
                url: 'https://api.openweathermap.org/data/2.5/weather?q=Santiago,CL&appid=demo&units=metric',
                parser: (data) => ({
                    temp: data.main?.temp || 18,
                    hum: data.main?.humidity || 65,
                    pressure: data.main?.pressure || 1020,
                    condition: data.weather?.[0]?.description || 'Despejado'
                })
            },
            {
                id: 'chile-wttr',
                name: 'WTTR.in Valpara√≠so',
                description: 'Estaci√≥n Meteorol√≥gica Valpara√≠so',
                city: 'Valpara√≠so, Chile',
                location: 'Puerto de Valpara√≠so',
                coordinates: '33.0472¬∞S, 71.6127¬∞W',
                provider: 'WTTR Weather Service Chile',
                climate: 'mediterraneo-costero',
                orchidSuitability: 'media',
                url: 'https://wttr.in/Valparaiso,Chile?format=j1',
                parser: (data) => ({
                    temp: parseFloat(data.current_condition?.[0]?.temp_C) || 16,
                    hum: parseFloat(data.current_condition?.[0]?.humidity) || 72,
                    pressure: parseFloat(data.current_condition?.[0]?.pressure) || 1018,
                    condition: data.current_condition?.[0]?.weatherDesc?.[0]?.value || 'Nublado'
                })
            },
            {
                id: 'chile-concepcion',
                name: 'OpenWeather Concepci√≥n',
                description: 'Estaci√≥n Meteorol√≥gica Concepci√≥n',
                city: 'Concepci√≥n, Chile',
                location: 'Aeropuerto Carriel Sur',
                coordinates: '36.7726¬∞S, 73.0631¬∞W',
                provider: 'OpenWeatherMap Chile Sur',
                climate: 'oceanico',
                orchidSuitability: 'media-baja',
                url: 'https://api.openweathermap.org/data/2.5/weather?q=Concepcion,CL&appid=demo&units=metric',
                parser: (data) => ({
                    temp: data.main?.temp || 14,
                    hum: data.main?.humidity || 78,
                    pressure: data.main?.pressure || 1016,
                    condition: data.weather?.[0]?.description || 'Parcialmente nublado'
                })
            },
            
            // ===== FUENTES PATAGONIA Y ZONAS FR√çAS =====
            {
                id: 'punta-arenas',
                name: 'WTTR.in Punta Arenas',
                description: 'Estaci√≥n Meteorol√≥gica Punta Arenas',
                city: 'Punta Arenas, Chile',
                location: 'Aeropuerto Carlos Ib√°√±ez del Campo',
                coordinates: '53.0024¬∞S, 70.8559¬∞W',
                provider: 'WTTR Weather Service Patagonia',
                climate: 'subpolar-oceanico',
                orchidSuitability: 'muy-baja',
                url: 'https://wttr.in/Punta_Arenas,Chile?format=j1',
                parser: (data) => ({
                    temp: parseFloat(data.current_condition?.[0]?.temp_C) || 8,
                    hum: parseFloat(data.current_condition?.[0]?.humidity) || 85,
                    pressure: parseFloat(data.current_condition?.[0]?.pressure) || 1005,
                    condition: data.current_condition?.[0]?.weatherDesc?.[0]?.value || 'Viento fuerte'
                })
            },
            {
                id: 'ushuaia',
                name: 'OpenWeather Ushuaia',
                description: 'Estaci√≥n Meteorol√≥gica Ushuaia',
                city: 'Ushuaia, Argentina',
                location: 'Aeropuerto Malvinas Argentinas',
                coordinates: '54.8433¬∞S, 68.2968¬∞W',
                provider: 'OpenWeatherMap Argentina',
                climate: 'subantartico',
                orchidSuitability: 'muy-baja',
                url: 'https://api.openweathermap.org/data/2.5/weather?q=Ushuaia,AR&appid=demo&units=metric',
                parser: (data) => ({
                    temp: data.main?.temp || 6,
                    hum: data.main?.humidity || 88,
                    pressure: data.main?.pressure || 1000,
                    condition: data.weather?.[0]?.description || 'Nublado y fr√≠o'
                })
            },
            {
                id: 'puerto-montt',
                name: 'OpenWeather Puerto Montt',
                description: 'Estaci√≥n Meteorol√≥gica Puerto Montt',
                city: 'Puerto Montt, Chile',
                location: 'Aeropuerto El Tepual',
                coordinates: '41.4693¬∞S, 73.0938¬∞W',
                provider: 'OpenWeatherMap Chile Sur',
                climate: 'oceanico-templado',
                orchidSuitability: 'baja',
                url: 'https://api.openweathermap.org/data/2.5/weather?q=Puerto_Montt,CL&appid=demo&units=metric',
                parser: (data) => ({
                    temp: data.main?.temp || 12,
                    hum: data.main?.humidity || 82,
                    pressure: data.main?.pressure || 1010,
                    condition: data.weather?.[0]?.description || 'Lluvia ligera'
                })
            }
        ];

        let currentSource = DATA_SOURCES[0]; // Fuente por defecto
        let realDataTimer = null;
        let sourceIndex = 0;
        let queryHistory = loadQueryHistory() || []; // Historial de todas las consultas
        let dataCache = {}; // Cache para datos estables
        const CACHE_DURATION = 15 * 60 * 1000; // 15 minutos

        // Verificar si hay datos v√°lidos en cache
        function getCachedData(sourceId) {
            const cached = dataCache[sourceId];
            if (!cached) return null;
            
            const now = Date.now();
            if (now - cached.timestamp < CACHE_DURATION) {
                return cached.data;
            }
            
            // Cache expirado
            delete dataCache[sourceId];
            return null;
        }

        // Guardar datos en cache
        function setCachedData(sourceId, data) {
            dataCache[sourceId] = {
                timestamp: Date.now(),
                data: data
            };
        }



        // Obtener datos REALES de la fuente ACTUAL seleccionada
        async function getRealIoTData() {
            // Verificar cache primero para la fuente actual
            const cacheKey = `realData_${currentSource.id}`;
            const cachedData = getCachedData(cacheKey);
            if (cachedData) {
                console.log(`Usando datos del cache para ${currentSource.city} (estables por 15 minutos)`);
                document.getElementById('realDataStatus').textContent = 'üíæ Datos del cache (estables)';
                
                // Actualizar UI con datos del cache SIN cambiar la fuente
                updateRealDataUI(cachedData.temperature, cachedData.humidity, cachedData.timestamp, cachedData.condition, false);
                return cachedData;
            }
            
            console.log(`Obteniendo datos de: ${currentSource.name} (${currentSource.city})`);
            document.getElementById('realDataStatus').textContent = `üì° Conectando a ${currentSource.city}...`;
            
            try {
                const response = await fetch(currentSource.url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                const parsed = currentSource.parser(data);
                
                if (!parsed.temp || !parsed.hum) {
                    throw new Error('Datos incompletos');
                }
                
                const timestamp = new Date();
                const temperature = Number(parsed.temp.toFixed(1));
                const humidity = Number(parsed.hum.toFixed(1));
                const condition = parsed.condition || '';
                
                // Actualizar UI con datos REALES SIN cambiar la fuente
                updateRealDataUI(temperature, humidity, timestamp, condition, false);
                
                // Guardar en cache espec√≠fico para esta ubicaci√≥n
                const dataToCache = { temperature, humidity, timestamp, condition };
                setCachedData(cacheKey, dataToCache);
                
                // A√±adir al gr√°fico principal
                const realReading = {
                    ts: timestamp.getTime(),
                    temp: temperature,
                    hum: humidity,
                    source: currentSource.id
                };
                
                history.push(realReading);
                if (history.length > 200) history.shift();
                saveHistory();
                refreshChart();
                
                // Actualizar tambi√©n los valores principales
                document.getElementById('tempValue').textContent = temperature.toFixed(1) + ' ¬∞C';
                document.getElementById('humValue').textContent = humidity.toFixed(1) + ' %';
                document.getElementById('lastUpdated').textContent = 
                    `√öltima actualizaci√≥n: ${timestamp.toLocaleString()} (${currentSource.city})`;
                
                return dataToCache;
                
            } catch (error) {
                console.log(`Error obteniendo datos de ${currentSource.city}:`, error.message);
                
                // Usar datos de respaldo SOLO si la fuente actual falla
                M.toast({ 
                    html: `‚ö†Ô∏è Error en ${currentSource.city}, usando datos simulados`,
                    classes: 'orange'
                });
                
                return await getFallbackData();
            }
                
        }

        // Funci√≥n de respaldo mejorada con datos realistas basados en la ubicaci√≥n actual
        async function getFallbackData() {
            const fallbackCacheKey = `fallback_${currentSource.id}`;
            
            // Verificar cache para datos de respaldo de esta ubicaci√≥n espec√≠fica
            const cachedFallback = getCachedData(fallbackCacheKey);
            if (cachedFallback) {
                console.log(`Usando datos simulados del cache para ${currentSource.city}`);
                document.getElementById('realDataStatus').textContent = `üîÑ Datos simulados de ${currentSource.city} (cache)`;
                updateRealDataUI(cachedFallback.temperature, cachedFallback.humidity, cachedFallback.timestamp, cachedFallback.condition, false);
                return cachedFallback;
            }
            
            console.log(`Generando datos simulados realistas para ${currentSource.city}`);
            
            // Simular datos basados en el clima de la ubicaci√≥n actual
            let baseTemp = 22; // Temperatura base
            let baseHum = 70;   // Humedad base
            
            // Ajustar datos base seg√∫n la ubicaci√≥n y clima
            switch (currentSource.climate) {
                case 'tropical-montano':
                case 'tropical-altitude':
                    baseTemp = 22; baseHum = 75; break;
                case 'tropical-seco':
                    baseTemp = 26; baseHum = 65; break;
                case 'mediterraneo':
                    baseTemp = 18; baseHum = 60; break;
                case 'mediterraneo-costero':
                    baseTemp = 16; baseHum = 70; break;
                case 'oceanico':
                    baseTemp = 14; baseHum = 78; break;
                case 'oceanico-templado':
                    baseTemp = 12; baseHum = 82; break;
                case 'subpolar-oceanico':
                    baseTemp = 8; baseHum = 85; break;
                case 'subantartico':
                    baseTemp = 6; baseHum = 88; break;
                default:
                    baseTemp = 20; baseHum = 70;
            }
            
            // Variaci√≥n basada en hora del d√≠a (m√°s realista)
            const hour = new Date().getHours();
            const tempVariation = Math.sin((hour - 6) / 24 * 2 * Math.PI) * 3; // ¬±3¬∞C variaci√≥n diaria
            const humVariation = Math.cos((hour - 12) / 24 * 2 * Math.PI) * 10; // ¬±10% variaci√≥n diaria
            
            const temperature = Number((baseTemp + tempVariation).toFixed(1));
            const humidity = Math.max(10, Math.min(100, Number((baseHum + humVariation).toFixed(1)))); // Limitar entre 10-100%
            const timestamp = new Date();
            
            // NO cambiar currentSource - mantener la ubicaci√≥n seleccionada
            const condition = `Simulaci√≥n realista para ${currentSource.city}`;
            
            updateRealDataUI(temperature, humidity, timestamp, condition, false);
            
            // A√±adir al gr√°fico
            const realReading = {
                ts: timestamp.getTime(),
                temp: temperature,
                hum: humidity,
                source: currentSource.id + '_simulated'
            };
            
            history.push(realReading);
            if (history.length > 200) history.shift();
            saveHistory();
            refreshChart();
            
            // Actualizar valores principales
            document.getElementById('tempValue').textContent = temperature.toFixed(1) + ' ¬∞C';
            document.getElementById('humValue').textContent = humidity.toFixed(1) + ' %';
            document.getElementById('lastUpdated').textContent = 
                `√öltima actualizaci√≥n: ${timestamp.toLocaleString()} (${currentSource.city} - Simulado)`;
            
            // Guardar datos de respaldo en cache espec√≠fico para esta ubicaci√≥n
            const fallbackData = { temperature, humidity, timestamp, condition };
            setCachedData(fallbackCacheKey, fallbackData);
            
            return fallbackData;
        }

        // Actualizar UI con datos reales
        function updateRealDataUI(temp, hum, timestamp, condition = '', updateSelector = true) {
            // Panel principal de datos
            document.getElementById('iotTemp').textContent = temp.toFixed(1) + '¬∞C';
            document.getElementById('iotHumidity').textContent = hum.toFixed(1) + '%';
            document.getElementById('iotSource').textContent = currentSource.description;
            document.getElementById('iotTimestamp').textContent = timestamp.toLocaleTimeString();
            
            // Determinar tipo de datos y mostrar indicador visual
            const isRealData = currentSource.id !== 'fallback-realistic';
            const isCachedData = document.getElementById('realDataStatus').textContent.includes('cache');
            
            let statusIcon = '';
            let statusText = '';
            let statusColor = '';
            
            if (isCachedData) {
                statusIcon = 'üíæ';
                statusText = `Datos del cache de ${currentSource.city} (estables por 15 min)`;
                statusColor = '#FF9800'; // Naranja
            } else if (isRealData) {
                statusIcon = 'üì°';
                statusText = `Datos meteorol√≥gicos reales de ${currentSource.city}`;
                statusColor = '#4CAF50'; // Verde
            } else {
                statusIcon = 'üîÑ';
                statusText = `Datos simulados para ${currentSource.city} (API no disponible)`;
                statusColor = '#2196F3'; // Azul
            }
            
            const statusElement = document.getElementById('realDataStatus');
            statusElement.innerHTML = `<span style="color: ${statusColor};">${statusIcon} ${statusText}</span>`;
            document.getElementById('realDataInfo').style.display = 'block';

            // Informaci√≥n detallada de la fuente
            document.getElementById('sourceStation').textContent = currentSource.description;
            document.getElementById('sourceLocation').textContent = `${currentSource.city} - ${currentSource.location}`;
            document.getElementById('sourceCoordinates').textContent = currentSource.coordinates;
            document.getElementById('sourceProvider').textContent = currentSource.provider;
            
            // Informaci√≥n adicional de clima y orqu√≠deas
            document.getElementById('sourceClimate').textContent = currentSource.climate || 'No especificado';
            
            const suitabilityElement = document.getElementById('sourceOrchidSuitability');
            const suitability = currentSource.orchidSuitability || 'no-evaluado';
            
            // Configurar el badge seg√∫n la adecuaci√≥n
            suitabilityElement.className = 'badge';
            switch (suitability) {
                case 'muy-alta':
                    suitabilityElement.className += ' green';
                    suitabilityElement.textContent = 'Muy Alta üå∏';
                    break;
                case 'alta':
                    suitabilityElement.className += ' light-green';
                    suitabilityElement.textContent = 'Alta üå∫';
                    break;
                case 'media-alta':
                    suitabilityElement.className += ' lime';
                    suitabilityElement.textContent = 'Media-Alta üåø';
                    break;
                case 'media':
                    suitabilityElement.className += ' orange';
                    suitabilityElement.textContent = 'Media ‚ö†Ô∏è';
                    break;
                case 'media-baja':
                    suitabilityElement.className += ' deep-orange';
                    suitabilityElement.textContent = 'Media-Baja ‚ùÑÔ∏è';
                    break;
                case 'baja':
                    suitabilityElement.className += ' red';
                    suitabilityElement.textContent = 'Baja ü•∂';
                    break;
                case 'muy-baja':
                    suitabilityElement.className += ' red darken-2';
                    suitabilityElement.textContent = 'Muy Baja üßä';
                    break;
                default:
                    suitabilityElement.className += ' grey';
                    suitabilityElement.textContent = 'No evaluado';
            }
            
            // Actualizar informaci√≥n de ubicaci√≥n actual
            document.getElementById('currentLocationName').textContent = currentSource.city;
            document.getElementById('currentClimate').textContent = `Clima ${currentSource.climate || 'no especificado'}`;
            document.getElementById('currentOrchidSuitability').textContent = 
                `Adecuaci√≥n para orqu√≠deas: ${suitabilityElement.textContent}`;
            
            // SOLO actualizar el selector si es un cambio manual (no autom√°tico)
            if (updateSelector) {
                const selector = document.getElementById('locationSelector');
                if (selector) {
                    selector.value = currentSource.id;
                    M.FormSelect.init(selector);
                }
            }

            // Agregar al historial de consultas
            addToQueryHistory(temp, hum, timestamp, condition);
        }

        // Agregar consulta al historial
        function addToQueryHistory(temp, hum, timestamp, condition = '') {
            const query = {
                id: Date.now(),
                timestamp: timestamp.getTime(),
                source: currentSource.name,
                sourceId: currentSource.id,
                city: currentSource.city,
                temperature: temp,
                humidity: hum,
                condition: condition,
                dateTime: timestamp.toLocaleString()
            };

            queryHistory.unshift(query); // A√±adir al principio
            
            // Mantener solo las √∫ltimas 50 consultas
            if (queryHistory.length > 50) {
                queryHistory = queryHistory.slice(0, 50);
            }
            
            saveQueryHistory();
            updateHistoryDisplay();
        }

        // Actualizar display del historial
        function updateHistoryDisplay() {
            const tbody = document.getElementById('queryHistoryTable');
            const totalElement = document.getElementById('totalQueries');
            
            totalElement.textContent = queryHistory.length;
            
            if (queryHistory.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="center-align grey-text">
                            No hay consultas realizadas
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = queryHistory.slice(0, 20).map(query => `
                <tr>
                    <td style="font-size: 0.8em;">
                        ${new Date(query.timestamp).toLocaleTimeString()}
                    </td>
                    <td style="font-size: 0.8em;">
                        ${query.city.split(',')[0]}
                    </td>
                    <td class="blue-text">
                        ${query.temperature.toFixed(1)}¬∞C
                    </td>
                    <td class="teal-text">
                        ${query.humidity.toFixed(1)}%
                    </td>
                </tr>
            `).join('');
        }

        // Event Listeners para botones IoT
        document.getElementById('btnRealTemp').addEventListener('click', async () => {
            try {
                const data = await getRealIoTData();
                M.toast({ html: `üå°Ô∏è Temperatura real: ${data.temperature.toFixed(1)}¬∞C` });
            } catch (error) {
                M.toast({ html: 'Error obteniendo temperatura real' });
            }
        });

        document.getElementById('btnRealHumidity').addEventListener('click', async () => {
            try {
                const data = await getRealIoTData();
                M.toast({ html: `üíß Humedad real: ${data.humidity.toFixed(1)}%` });
            } catch (error) {
                M.toast({ html: 'Error obteniendo humedad real' });
            }
        });

        // Auto-actualizaci√≥n cada 2 minutos con datos REALES
        let autoRealActive = false;
        
        function startRealDataAutoUpdate() {
            if (realDataTimer) clearInterval(realDataTimer);
            
            realDataTimer = setInterval(async () => {
                try {
                    await getRealIoTData();
                    console.log('Datos IoT actualizados autom√°ticamente');
                } catch (error) {
                    console.log('Error en actualizaci√≥n autom√°tica IoT:', error);
                }
            }, 120000); // 2 minutos
            
            autoRealActive = true;
            document.getElementById('btnAutoReal').innerHTML = 
                '<i class="material-icons left">pause</i>Auto: ON';
            M.toast({ html: 'üîÑ Auto-actualizaci√≥n IoT activada (cada 2 min)' });
        }
        
        function stopRealDataAutoUpdate() {
            if (realDataTimer) {
                clearInterval(realDataTimer);
                realDataTimer = null;
            }
            autoRealActive = false;
            document.getElementById('btnAutoReal').innerHTML = 
                '<i class="material-icons left">refresh</i>Auto Real';
            M.toast({ html: '‚èπÔ∏è Auto-actualizaci√≥n IoT desactivada' });
        }

        // Bot√≥n toggle auto-actualizaci√≥n IoT
        document.getElementById('btnAutoReal').addEventListener('click', () => {
            if (autoRealActive) {
                stopRealDataAutoUpdate();
            } else {
                startRealDataAutoUpdate();
            }
        });

        // Funci√≥n para cambiar la fuente de datos actual
        function changeDataSource(sourceId) {
            const newSource = DATA_SOURCES.find(source => source.id === sourceId);
            if (newSource) {
                const previousCity = currentSource.city;
                currentSource = newSource;
                
                console.log(`Cambiando de ${previousCity} a ${currentSource.city}`);
                
                // Actualizar UI inmediatamente con informaci√≥n de la nueva ubicaci√≥n
                document.getElementById('currentLocationName').textContent = currentSource.city;
                document.getElementById('currentClimate').textContent = `Clima ${currentSource.climate || 'no especificado'}`;
                
                const suitability = currentSource.orchidSuitability || 'no-evaluado';
                let suitabilityText = '';
                switch (suitability) {
                    case 'muy-alta': suitabilityText = 'Muy Alta üå∏'; break;
                    case 'alta': suitabilityText = 'Alta üå∫'; break;
                    case 'media-alta': suitabilityText = 'Media-Alta üåø'; break;
                    case 'media': suitabilityText = 'Media ‚ö†Ô∏è'; break;
                    case 'media-baja': suitabilityText = 'Media-Baja ‚ùÑÔ∏è'; break;
                    case 'baja': suitabilityText = 'Baja ü•∂'; break;
                    case 'muy-baja': suitabilityText = 'Muy Baja üßä'; break;
                    default: suitabilityText = 'No evaluado';
                }
                document.getElementById('currentOrchidSuitability').textContent = 
                    `Adecuaci√≥n para orqu√≠deas: ${suitabilityText}`;
                
                // Limpiar datos anteriores del display
                document.getElementById('iotTemp').textContent = '--¬∞C';
                document.getElementById('iotHumidity').textContent = '--%';
                document.getElementById('realDataStatus').textContent = `üîÑ Preparando datos de ${currentSource.city}...`;
                
                M.toast({ 
                    html: `üìç Ubicaci√≥n cambiada a: ${currentSource.city}`,
                    classes: 'purple darken-2'
                });
                
                // Obtener datos de la nueva ubicaci√≥n inmediatamente
                setTimeout(() => {
                    getRealIoTData();
                }, 500);
            } else {
                M.toast({ html: 'Error: Ubicaci√≥n no encontrada', classes: 'red' });
            }
        }

        // Event listener para el bot√≥n de cambiar ubicaci√≥n
        document.getElementById('btnChangeLocation').addEventListener('click', () => {
            const selectedSourceId = document.getElementById('locationSelector').value;
            if (selectedSourceId) {
                changeDataSource(selectedSourceId);
            } else {
                M.toast({ html: 'Por favor selecciona una ubicaci√≥n', classes: 'orange' });
            }
        });

        // localStorage helpers
        function saveHistory() { localStorage.setItem('orch_history', JSON.stringify(history)); }
        function loadHistory() { try { return JSON.parse(localStorage.getItem('orch_history') || '[]'); } catch (e) { return []; } }
        function saveQueryHistory() { localStorage.setItem('orch_query_history', JSON.stringify(queryHistory)); }
        function loadQueryHistory() { try { return JSON.parse(localStorage.getItem('orch_query_history') || '[]'); } catch (e) { return []; } }

        // Inicializaci√≥n
        refreshChart();
        updateHistoryDisplay();
        
        // Inicializar selector de ubicaciones y mostrar informaci√≥n inicial
        setTimeout(() => {
            // Inicializar selector de Materialize
            const selector = document.getElementById('locationSelector');
            if (selector) {
                M.FormSelect.init(selector);
                selector.value = currentSource.id;
                M.FormSelect.init(selector); // Reinicializar para mostrar la selecci√≥n
            }
            
            // Mostrar informaci√≥n inicial de la ubicaci√≥n
            document.getElementById('currentLocationName').textContent = currentSource.city;
            document.getElementById('currentClimate').textContent = `Clima ${currentSource.climate || 'no especificado'}`;
            
            const suitability = currentSource.orchidSuitability || 'no-evaluado';
            let suitabilityText = '';
            switch (suitability) {
                case 'muy-alta': suitabilityText = 'Muy Alta üå∏'; break;
                case 'alta': suitabilityText = 'Alta üå∫'; break;
                case 'media-alta': suitabilityText = 'Media-Alta üåø'; break;
                case 'media': suitabilityText = 'Media ‚ö†Ô∏è'; break;
                case 'media-baja': suitabilityText = 'Media-Baja ‚ùÑÔ∏è'; break;
                case 'baja': suitabilityText = 'Baja ü•∂'; break;
                case 'muy-baja': suitabilityText = 'Muy Baja üßä'; break;
                default: suitabilityText = 'No evaluado';
            }
            document.getElementById('currentOrchidSuitability').textContent = 
                `Adecuaci√≥n para orqu√≠deas: ${suitabilityText}`;
                
            // Estado inicial
            document.getElementById('realDataStatus').textContent = `üåê Ubicaci√≥n: ${currentSource.city} - Presiona un bot√≥n para obtener datos`;
        }, 100);

        // Guardar estado al cerrar pesta√±a
        window.addEventListener('beforeunload', () => {
            saveHistory();
        });
    </script>
</body>

</html>
